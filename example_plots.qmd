---
title: "Example Plots"
date: "`r Sys.Date()`"
author: "Meini Tang"
pdf-engine: pdflatex
format: 
  pdf:
    include-in-header:
      text: |
        \usepackage{geometry}
        \usepackage{booktabs}
        \usepackage{float}
        \usepackage{pdflscape}
        \usepackage{hhline}
    toc: true
    toc-depth: 2
    number-sections: true
    number-depth: 2
    fig-align: 'center'
    fig-pos: 'H'
    keep-tex: true
    tbl-cap-location: bottom
    layout-valign: bottom
error: true
---

```{r}
#| label: source code
mod <- "save"
save_figures <- TRUE
plot_figures = TRUE
fig_width = 11.5
fig_height = 4

kstep_forecast_err <- 10


library(ggplot2)
library(gridExtra)

repo <- "/Users/meinitang/Dropbox/Repository/poisson-dlm"
Rcpp::sourceCpp(file.path(repo, "export.cpp"))

source(file.path(repo, "plot_timeseries_creditble_interval.r"))
source(file.path(repo, "load_data.r"))
source(file.path(repo, "external_methods.r"))

dpath <- "/Users/meinitang/Dropbox/Research/Project1"
opath <- "/Users/meinitang/Dropbox/Research/Project1/simulation"
opath_real <- "/Users/meinitang/Dropbox/Research/Project1/real"
```



## S1. seed = 3269

```{r}
#| label: load data
seed <- 3269

sim1.dat <- load_dat(opath, seed)
sim1.dat <- load_sim(seed, sim1.dat)
print(ls(envir = sim1.dat))

dat <- get_dat_sim_loss_all(sim1.dat)
print(dat)
```

### Data

```{r}
p1 <- ggplot(
    data = data.frame(y = sim1.dat$sim1$y, t = 0:(length(sim1.dat$sim1$y) - 1)),
    aes(x = t, y = y)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Observed Count Values y")

p2 <- ggplot(
    data = data.frame(psi = sim1.dat$sim1$psi, t = 0:(length(sim1.dat$sim1$psi) - 1)),
    aes(x = t, y = psi)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Latent State psi")


p <- arrangeGrob(grobs = list(y = p1, psi = p2), ncol = 1)

plot(p)

```

### k-step forecasting error

```{r}
dat1 <- subset_dat_loss_all(dat, kstep_forecast_err, "W")
p1 <- plot_mfe(dat1)
p1 <- p1 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat2 <- subset_dat_loss_all(dat, kstep_forecast_err, "Wt")
dat2 <- data.frame(
    k = dat$k[1:10],
    `LBA` = dat$`LBA.DF`[1:10],
    `MCS` = dat$MCS.DF[1:10],
    `FFBS` = dat$FFBS.DF[1:10],
    EpiEstim = dat$EPI[1:10],
    WT = dat$WT[1:10]
)


p2 <- plot_mfe(dat2)
p2 <- p2 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat3 <- subset_dat_loss_all(dat, kstep_forecast_err, "WvsWt")
p3 <- plot_mfe(dat3)
p3 <- p3 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))


if (plot_figures) {
    plot(p1)
    plot(p2)
    plot(p3)
}


if (save_figures) {
    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-Wt.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-W-vs-Wt.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )
}
```

```{r}
dat
```


```{r}
k = 10

p = plot_ts_ci_multi(
  list(
    LBA = sim1.dat$out1.lba$error$forecast$y_cast[1:(length(sim1.dat$sim1$y) - 10),,k],
    MCS = sim1.dat$out1.mcs$error$forecast$y_cast[1:(length(sim1.dat$sim1$y) - 10),,k],
    FFBS = sim1.dat$out1.ffbs$error$forecast$y_cast[1:(length(sim1.dat$sim1$y) - 10),,k],
    PL = sim1.dat$out1.pl$error$forecast$y_cast[1:(length(sim1.dat$sim1$y) - 10),,k],
    HVA = sim1.dat$out1.hva$error$forecast$y_cast[1:(length(sim1.dat$sim1$y) - 10),,k],
    MCMC = sim1.dat$out1.mcmc$error$forecast$y_cast[1:(length(sim1.dat$sim1$y) - 10),,k],
    # WT = sim1.dat$out1.wt,
    True = cbind(sim1.dat$sim1$y[1:(length(sim1.dat$sim1$y) - 10)], sim1.dat$sim1$y[1:(length(sim1.dat$sim1$y) - 10)], sim1.dat$sim1$y[1:(length(sim1.dat$sim1$y) - 10)])
  ), 
  legend.position = "top"
)

p = p + ylab(expression(y[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-", k,"step.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

### Posterior of W

```{r}
p1 <- ggplot(
    data = data.frame(w = c(sim1.dat$out1.hva$fit$W), idx = 1:length(sim1.dat$out1.hva$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "HVA: Posterior distribution of W")
plot(p1)


p2 <- ggplot(
    data = data.frame(w = c(sim1.dat$out1.mcmc$fit$W), idx = 1:length(sim1.dat$out1.mcmc$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "MCMC: Posterior distribution of W")
plot(p2)

p3 <- ggplot(
    data = data.frame(w = c(sim1.dat$out1.pl$fit$W[,length(sim1.dat$sim1$y)]), idx = 1:length(sim1.dat$out1.pl$fit$W[,length(sim1.dat$sim1$y)])),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "PL: Posterior distribution of W")
plot(p3)

if (mode == "save") {
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-hva-posterior-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-mcmc-posterior-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-pl-posterior-W.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300
    )
}
```

### Posterior of Rt

```{r}
p = plot_ts_ci_multi(
  list(
    LBA = log(exp(sim1.dat$out1.lba$fit$psi) + 1),
    MCS = log(exp(sim1.dat$out1.mcs$fit$psi) + 1),
    FFBS = log(exp(sim1.dat$out1.ffbs$fit$psi) + 1),
    PL = log(exp(sim1.dat$out1.pl$fit$psi) + 1),
    HVA = log(exp(sim1.dat$out1.hva$fit$psi) + 1),
    MCMC = log(exp(sim1.dat$out1.mcmc$fit$psi) + 1),
    WT = sim1.dat$out1.wt,
    EpiEstim = sim1.dat$out1.epi,
    True = log(exp(cbind(sim1.dat$sim1$psi, sim1.dat$sim1$psi, sim1.dat$sim1$psi)) + 1)
  ), 
  legend.position = "top"
)

p = p + ylab(expression(R[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath, "posterior",
            paste0("sim-", seed, "-Rt.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

## S2. seed = 2793

```{r}
#| label: load data
seed <- 2793

sim2.dat <- load_dat(opath, seed)
sim2.dat <- load_sim(seed, sim2.dat)
print(ls(envir = sim2.dat))

dat <- get_dat_sim_loss_all(sim2.dat)
print(dat)
```

### Data

```{r}

p1 <- ggplot(
    data = data.frame(y = sim2.dat$sim1$y, t = 0:(length(sim2.dat$sim1$y) - 1)),
    aes(x = t, y = y)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Observed Count Values y")

p2 <- ggplot(
    data = data.frame(psi = sim2.dat$sim1$psi, t = 0:(length(sim2.dat$sim1$psi) - 1)),
    aes(x = t, y = psi)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Latent State psi")


p <- arrangeGrob(grobs = list(y = p1, psi = p2), ncol = 1)

plot(p)
```

### k-step forecasting error

```{r}
dat1 <- subset_dat_loss_all(dat, kstep_forecast_err, "W")
p1 <- plot_mfe(dat1)
p1 <- p1 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat2 <- subset_dat_loss_all(dat, kstep_forecast_err, "Wt")
dat2 <- data.frame(
    k = dat$k[1:10],
    `LBA` = dat$`LBA.DF`[1:10],
    `MCS` = dat$MCS.DF[1:10],
    `FFBS` = dat$FFBS.DF[1:10],
    EpiEstim = dat$EPI[1:10],
    WT = dat$WT[1:10]
)


p2 <- plot_mfe(dat2)
p2 <- p2 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat3 <- subset_dat_loss_all(dat, kstep_forecast_err, "WvsWt")
p3 <- plot_mfe(dat3)
p3 <- p3 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))


if (plot_figures) {
    plot(p1)
    plot(p2)
    plot(p3)
}


if (save_figures) {
    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-Wt.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-W-vs-Wt.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )
}
```

```{r}
dat
```

```{r}
k = 10

p = plot_ts_ci_multi(
  list(
    LBA = sim2.dat$out1.lba$error$forecast$y_cast[1:(length(sim2.dat$sim1$y) - 10),,k],
    MCS = sim2.dat$out1.mcs$error$forecast$y_cast[1:(length(sim2.dat$sim1$y) - 10),,k],
    FFBS = sim2.dat$out1.ffbs$error$forecast$y_cast[1:(length(sim2.dat$sim1$y) - 10),,k],
    PL = sim2.dat$out1.pl$error$forecast$y_cast[1:(length(sim2.dat$sim1$y) - 10),,k],
    HVA = sim2.dat$out1.hva$error$forecast$y_cast[1:(length(sim2.dat$sim1$y) - 10),,k],
    MCMC = sim2.dat$out1.mcmc$error$forecast$y_cast[1:(length(sim2.dat$sim1$y) - 10),,k],
    True = cbind(sim2.dat$sim1$y[1:(length(sim2.dat$sim1$y) - 10)], sim2.dat$sim1$y[1:(length(sim2.dat$sim1$y) - 10)], sim2.dat$sim1$y[1:(length(sim2.dat$sim1$y) - 10)])
  ), 
  legend.position = "top"
)

p = p + ylab(expression(R[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12)) +
  ylab(expression(y[t]))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-", k,"step.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

### Posterior of W

```{r}
try({
p1 <- ggplot(
    data = data.frame(w = c(sim2.dat$out1.hva$fit$W), idx = 1:length(sim2.dat$out1.hva$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "HVA: Posterior distribution of W")
plot(p1)
})


try({
p2 <- ggplot(
    data = data.frame(w = c(sim2.dat$out1.mcmc$fit$W), idx = 1:length(sim2.dat$out1.mcmc$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "MCMC: Posterior distribution of W")
plot(p2)
})

try({
p3 <- ggplot(
    data = data.frame(w = c(sim2.dat$out1.pl$fit$W[,length(sim2.dat$sim1$y)]), idx = 1:length(sim2.dat$out1.pl$fit$W[,length(sim2.dat$sim1$y)])),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "PL: Posterior distribution of W")
plot(p3)
})


if (mode == "save") {
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-hva-posterior-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-mcmc-posterior-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-pl-posterior-W.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300
    )
}
```

### Posterior of Rt

```{r}
p = plot_ts_ci_multi(
  list(
    LBA = log(exp(sim2.dat$out1.lba$fit$psi) + 1),
    MCS = log(exp(sim2.dat$out1.mcs$fit$psi) + 1),
    FFBS = log(exp(sim2.dat$out1.ffbs$fit$psi) + 1),
    PL = log(exp(sim2.dat$out1.pl$fit$psi) + 1),
    HVA = log(exp(sim2.dat$out1.hva$fit$psi) + 1),
    MCMC = log(exp(sim2.dat$out1.mcmc$fit$psi) + 1),
    WT = sim2.dat$out1.wt,
    EpiEstim = sim2.dat$out1.epi,
    True = log(exp(cbind(sim2.dat$sim1$psi, sim2.dat$sim1$psi, sim2.dat$sim1$psi)) + 1)
  ), 
  legend.position = "top"
)

p = p + ylab(expression(R[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath, "posterior",
            paste0("sim-", seed, "-Rt.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```


## S3. seed = 8434

```{r}
#| label: load data
seed <- 8434

sim3.dat <- load_dat(opath, seed)
sim3.dat <- load_sim(seed, sim3.dat)
print(ls(envir = sim3.dat))

dat <- get_dat_sim_loss_all(sim3.dat)
print(dat)
```

### Data

```{r}
p1 <- ggplot(
    data = data.frame(y = sim3.dat$sim1$y, t = 0:(length(sim3.dat$sim1$y) - 1)),
    aes(x = t, y = y)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Observed Count Values y")

p2 <- ggplot(
    data = data.frame(psi = sim3.dat$sim1$psi, t = 0:(length(sim3.dat$sim1$psi) - 1)),
    aes(x = t, y = psi)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Latent State psi")


p <- arrangeGrob(grobs = list(y = p1, psi = p2), ncol = 1)

plot(p)
```

### k-step forecasting error

```{r}
dat1 <- subset_dat_loss_all(dat, kstep_forecast_err, "W")
p1 <- plot_mfe(dat1)
p1 <- p1 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat2 <- subset_dat_loss_all(dat, kstep_forecast_err, "Wt")
dat2 <- data.frame(
    k = dat$k[1:10],
    `LBA` = dat$`LBA.DF`[1:10],
    `MCS` = dat$MCS.DF[1:10],
    `FFBS` = dat$FFBS.DF[1:10],
    EpiEstim = dat$EPI[1:10],
    WT = dat$WT[1:10]
)


p2 <- plot_mfe(dat2)
p2 <- p2 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat3 <- subset_dat_loss_all(dat, kstep_forecast_err, "WvsWt")
p3 <- plot_mfe(dat3)
p3 <- p3 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))


if (plot_figures) {
    plot(p1)
    plot(p2)
    plot(p3)
}


if (save_figures) {
    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-Wt.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-mfe-W-vs-Wt.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )
}
```

```{r}
dat
```

```{r}
k = 5

p = plot_ts_ci_multi(
  list(
    LBA = sim3.dat$out1.lba$error$forecast$y_cast[1:(length(sim3.dat$sim1$y) - 10),,k],
    MCS = sim3.dat$out1.mcs$error$forecast$y_cast[1:(length(sim3.dat$sim1$y) - 10),,k],
    FFBS = sim3.dat$out1.ffbs$error$forecast$y_cast[1:(length(sim3.dat$sim1$y) - 10),,k],
    PL = sim3.dat$out1.pl$error$forecast$y_cast[1:(length(sim3.dat$sim1$y) - 10),,k],
    HVA = sim3.dat$out1.hva$error$forecast$y_cast[1:(length(sim3.dat$sim1$y) - 10),,k],
    MCMC = sim3.dat$out1.mcmc$error$forecast$y_cast[1:(length(sim3.dat$sim1$y) - 10),,k],
    # WT = sim3.dat$out1.wt,
    True = cbind(sim3.dat$sim1$y[1:(length(sim3.dat$sim1$y) - 10)], sim3.dat$sim1$y[1:(length(sim3.dat$sim1$y) - 10)], sim3.dat$sim1$y[1:(length(sim3.dat$sim1$y) - 10)])
  ), 
  legend.position = "top"
)

p = p + ylab(expression(y[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath, "forecast",
            paste0("sim-", seed, "-", k,"step.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

### Posterior of W

```{r}
try({
p1 <- ggplot(
    data = data.frame(w = c(sim3.dat$out1.hva$fit$W), idx = 1:length(sim3.dat$out1.hva$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "HVA: Posterior distribution of W")
plot(p1)
})


try({
p2 <- ggplot(
    data = data.frame(w = c(sim3.dat$out1.mcmc$fit$W), idx = 1:length(sim3.dat$out1.mcmc$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "MCMC: Posterior distribution of W")
plot(p2)
})

try({
p3 <- ggplot(
    data = data.frame(w = c(sim3.dat$out1.pl$fit$W[,length(sim3.dat$sim1$y)]), idx = 1:length(sim3.dat$out1.pl$fit$W[,length(sim3.dat$sim1$y)])),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "PL: Posterior distribution of W")
plot(p3)
})


if (mode == "save") {
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-hva-posterior-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-mcmc-posterior-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-pl-posterior-W.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300
    )
}
```

### Posterior of Rt

```{r}
p = plot_ts_ci_multi(
  list(
    LBA = log(exp(sim3.dat$out1.lba$fit$psi) + 1),
    MCS = log(exp(sim3.dat$out1.mcs$fit$psi) + 1),
    FFBS = log(exp(sim3.dat$out1.ffbs$fit$psi) + 1),
    PL = log(exp(sim3.dat$out1.pl$fit$psi) + 1),
    HVA = log(exp(sim3.dat$out1.hva$fit$psi) + 1),
    MCMC = log(exp(sim3.dat$out1.mcmc$fit$psi) + 1),
    EpiEstim = sim3.dat$out1.epi,
    WT = sim3.dat$out1.wt,
    True = log(exp(cbind(sim3.dat$sim1$psi, sim3.dat$sim1$psi, sim3.dat$sim1$psi)) + 1)
  ), 
  legend.position = "top"
)

p = p + ylab(expression(R[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (save_figures) {
  ggsave(
        file.path(
            opath, "posterior",
            paste0("sim-", seed, "-Rt.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```


## Santa Cruz

```{r}
tag = "santacruz"
santacruz.dat = load_dat(opath_real,tag, "covid")
santacruz.dat = load_real(dpath, "Santa Cruz", santacruz.dat)
print(ls(santacruz.dat))
```

### k-step forecasting

```{r}
dat <- get_dat_real_loss_all(santacruz.dat)


dat1 <- subset_dat_loss_all(dat, kstep_forecast_err, "W")
p1 <- plot_mfe(dat1)
p1 <- p1 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat2 <- subset_dat_loss_all(dat, kstep_forecast_err, "Wt")
dat2 <- data.frame(
    k = dat$k[1:10],
    `LBA` = dat$`LBA.DF`[1:10],
    `MCS` = dat$MCS.DF[1:10],
    `FFBS` = dat$FFBS.DF[1:10],
    EpiEstim = dat$EPI[1:10],
    WT = dat$WT[1:10]
)


p2 <- plot_mfe(dat2)
p2 <- p2 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat3 <- subset_dat_loss_all(dat, kstep_forecast_err, "WvsWt")
p3 <- plot_mfe(dat3)
p3 <- p3 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))


if (plot_figures) {
    plot(p1)
    plot(p2)
    plot(p3)
}


if (save_figures) {
    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-Wt.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-W-vs-Wt.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )
}
```

```{r}
k = 5

p = plot_ts_ci_multi(
  list(
    LBA = santacruz.dat$out.lba$error$forecast$y_cast[1:(length(santacruz.dat$y2) - 10),,k],
    MCS = santacruz.dat$out.mcs$error$forecast$y_cast[1:(length(santacruz.dat$y2) - 10),,k],
    FFBS = santacruz.dat$out.ffbs$error$forecast$y_cast[1:(length(santacruz.dat$y2) - 10),,k],
    PL = santacruz.dat$out.pl$error$forecast$y_cast[1:(length(santacruz.dat$y2) - 10),,k],
    # HVA = santacruz.dat$out.hva$error$forecast$y_cast[1:(length(santacruz.dat$y2) - 10),,k],
    # MCMC = log(exp(santacruz.dat$out1.mcmc$fit$psi) + 1),
    # WT = t(santacruz.dat$forecast.wt$y_cast[,1:(length(santacruz.dat$y2) - 10),k]),
    True = cbind(santacruz.dat$y2[1:(length(santacruz.dat$y2) - 10)], santacruz.dat$y2[1:(length(santacruz.dat$y2) - 10)], santacruz.dat$y2[1:(length(santacruz.dat$y2) - 10)])
  ), 
  legend.position = "top"
)

p = p + ylab(expression(y[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-", k,"step.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

### Posterior of W

```{r}
try({
p1 <- ggplot(
    data = data.frame(w = c(santacruz.dat$out.hva$fit$W), idx = 1:length(santacruz.dat$out.hva$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "HVA: Posterior distribution of W")
plot(p1)
})


try({
p2 <- ggplot(
    data = data.frame(w = c(santacruz.dat$out.mcmc$fit$W), idx = 1:length(santacruz.dat$out.mcmc$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "MCMC: Posterior distribution of W")
plot(p2)
})

try({
p3 <- ggplot(
    data = data.frame(w = c(santacruz.dat$out.pl$fit$W[,length(santacruz.dat$y2)]), idx = 1:length(santacruz.dat$out.pl$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50, na.rm = TRUE) +
    labs(title = "PL: Posterior distribution of W")
plot(p3)
})


if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-hva-posterior-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-mcmc-posterior-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-pl-posterior-W.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300
    )
}
```

### Posterior of Rt

```{r}
p = plot_ts_ci_multi(
  list(
    LBA = log(exp(santacruz.dat$out.lba$fit$psi) + 1),
    MCS = log(exp(santacruz.dat$out.mcs$fit$psi) + 1),
    FFBS = log(exp(santacruz.dat$out.ffbs$fit$psi) + 1),
    PL = log(exp(santacruz.dat$out.pl$fit$psi) + 1),
    # HVA = log(exp(santacruz.dat$out.hva$fit$psi) + 1),
    # MCMC = log(exp(santacruz.dat$out.mcmc$fit$psi) + 1),
    WT = santacruz.dat$out.wt,
    EpiEstim = santacruz.dat$out.epi
  ), 
  legend.position = "top"
)

p = p + ylab(expression(R[t]))
p = p + ylab(expression(R[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "posterior",
            paste0("covid-", tag, "-Rt.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

## Santa Clara

```{r}
tag = "santaclara"
santaclara.dat = load_dat(opath_real, tag, "covid")
santaclara.dat = load_real(dpath, "Santa Clara", santaclara.dat)
print(ls(santaclara.dat))
```

### k-step forecasting error

```{r}
dat <- get_dat_real_loss_all(santaclara.dat)


dat1 <- subset_dat_loss_all(dat, kstep_forecast_err, "W")
p1 <- plot_mfe(dat1)
p1 <- p1 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat2 <- subset_dat_loss_all(dat, kstep_forecast_err, "Wt")
dat2 <- data.frame(
    k = dat$k[1:10],
    `LBA` = dat$`LBA.DF`[1:10],
    `MCS` = dat$MCS.DF[1:10],
    `FFBS` = dat$FFBS.DF[1:10],
    EpiEstim = dat$EPI[1:10],
    WT = dat$WT[1:10]
)


p2 <- plot_mfe(dat2)
p2 <- p2 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat3 <- subset_dat_loss_all(dat, kstep_forecast_err, "WvsWt")
p3 <- plot_mfe(dat3)
p3 <- p3 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))


if (plot_figures) {
    plot(p1)
    plot(p2)
    plot(p3)
}


if (save_figures) {
    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-Wt.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-W-vs-Wt.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )
}
```

```{r}
k = 5

p = plot_ts_ci_multi(
  list(
    LBA = santaclara.dat$out.lba$error$forecast$y_cast[1:(length(santaclara.dat$y2) - 10),,k],
    MCS = santaclara.dat$out.mcs$error$forecast$y_cast[1:(length(santaclara.dat$y2) - 10),,k],
    # FFBS = santaclara.dat$out.ffbs$error$forecast$y_cast[1:(length(santaclara.dat$y2) - 10),,k],
    PL = santaclara.dat$out.pl$error$forecast$y_cast[1:(length(santaclara.dat$y2) - 10),,k],
    # HVA = santaclara.dat$out.hva$error$forecast$y_cast[1:(length(santaclara.dat$y2) - 10),,k],
    # MCMC = log(exp(santaclara.dat$out1.mcmc$fit$psi) + 1),
    # WT = santaclara.dat$out1.wt,
    True = cbind(santaclara.dat$y2[1:(length(santaclara.dat$y2) - 10)], santaclara.dat$y2[1:(length(santaclara.dat$y2) - 10)], santaclara.dat$y2[1:(length(santaclara.dat$y2) - 10)])
  ), 
  legend.position = "top"
)

p = p + ylab(expression(y[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-", k,"step.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

### Posterior of W

```{r}
try({
p1 <- ggplot(
    data = data.frame(w = c(santaclara.dat$out.hva$fit$W), idx = 1:length(santaclara.dat$out.hva$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "HVA: Posterior distribution of W")
plot(p1)
})


try({
p2 <- ggplot(
    data = data.frame(w = c(santaclara.dat$out.mcmc$fit$W), idx = 1:length(santaclara.dat$out.mcmc$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "MCMC: Posterior distribution of W")
plot(p2)
})

try({
p3 <- ggplot(
    data = data.frame(w = c(santaclara.dat$out.pl$fit$W[,length(santaclara.dat$y2)]), idx = 1:length(santaclara.dat$out.pl$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "PL: Posterior distribution of W")
plot(p3)
})


if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-hva-posterior-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-mcmc-posterior-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-pl-posterior-W.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300
    )
}
```

### Posterior of Rt

```{r}
p = plot_ts_ci_multi(
  list(
    LBA = log(exp(santaclara.dat$out.lba$fit$psi) + 1),
    MCS = log(exp(santaclara.dat$out.mcs$fit$psi) + 1),
    FFBS = log(exp(santaclara.dat$out.ffbs$fit$psi) + 1),
    PL = log(exp(santaclara.dat$out.pl$fit$psi) + 1),
    # HVA = log(exp(santaclara.dat$out.hva$fit$psi) + 1)
    # MCMC = log(exp(santaclara.dat$out.mcmc$fit$psi) + 1),
    WT = santaclara.dat$out.wt,
    EpiEstim = santaclara.dat$out.epi
  ), 
  legend.position = "top"
)

p = p + ylab(expression(R[t]))
p = p + ylab(expression(R[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "posterior",
            paste0("covid-", tag, "-Rt.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

## Monterey

```{r}
tag = "monterey"
monterey.dat = load_dat(opath_real, tag, "covid")
monterey.dat = load_real(dpath, "Monterey", monterey.dat)
print(ls(monterey.dat))
```

### k-step forecasting error

```{r}
dat <- get_dat_real_loss_all(monterey.dat)


dat1 <- subset_dat_loss_all(dat, kstep_forecast_err, "W")
p1 <- plot_mfe(dat1)
p1 <- p1 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat2 <- subset_dat_loss_all(dat, kstep_forecast_err, "Wt")
dat2 <- data.frame(
    k = dat$k[1:10],
    `LBA` = dat$`LBA.DF`[1:10],
    `MCS` = dat$MCS.DF[1:10],
    `FFBS` = dat$FFBS.DF[1:10],
    EpiEstim = dat$EPI[1:10],
    WT = dat$WT[1:10]
)


p2 <- plot_mfe(dat2)
p2 <- p2 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))



dat3 <- subset_dat_loss_all(dat, kstep_forecast_err, "WvsWt")
p3 <- plot_mfe(dat3)
p3 <- p3 + ylab("RMSE") +
    guides(color = guide_legend(nrow = 1)) +
    theme(text = element_text(size = 12))


if (plot_figures) {
    plot(p1)
    plot(p2)
    plot(p3)
}


if (save_figures) {
    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-Wt.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )

    ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-mfe-W-vs-Wt.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300,
        width = fig_width, height = fig_height
    )
}
```

```{r}
k = 10

p = plot_ts_ci_multi(
  list(
    LBA = monterey.dat$out.lba$error$forecast$y_cast[1:(length(monterey.dat$y2) - 10),,k],
    MCS = monterey.dat$out.mcs$error$forecast$y_cast[1:(length(monterey.dat$y2) - 10),,k],
    FFBS = monterey.dat$out.ffbs$error$forecast$y_cast[1:(length(monterey.dat$y2) - 10),,k],
    PL = monterey.dat$out.pl$error$forecast$y_cast[1:(length(monterey.dat$y2) - 10),,k],
    # HVA = monterey.dat$out.hva$error$forecast$y_cast[1:(length(monterey.dat$y2) - 10),,k],
    # MCMC = log(exp(monterey.dat$out1.mcmc$fit$psi) + 1),
    # WT = monterey.dat$out1.wt,
    True = cbind(monterey.dat$y2[1:(length(monterey.dat$y2) - 10)], monterey.dat$y2[1:(length(monterey.dat$y2) - 10)], monterey.dat$y2[1:(length(monterey.dat$y2) - 10)])
  ), 
  legend.position = "top"
)

p = p + ylab(expression(y[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "forecast",
            paste0("covid-", tag, "-", k,"step.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```

### Posterior of W

```{r}
try({
p1 <- ggplot(
    data = data.frame(w = c(monterey.dat$out.hva$fit$W), idx = 1:length(monterey.dat$out.hva$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "HVA: Posterior distribution of W")
plot(p1)
})


try({
p2 <- ggplot(
    data = data.frame(w = c(monterey.dat$out.mcmc$fit$W), idx = 1:length(monterey.dat$out.mcmc$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "MCMC: Posterior distribution of W")
plot(p2)
})

try({
p3 <- ggplot(
    data = data.frame(w = c(monterey.dat$out.pl$fit$W[,length(monterey.dat$y2)]), idx = 1:length(monterey.dat$out.pl$fit$W)),
    aes(x = w)
) +
    theme_light() +
    geom_histogram(bins = 50) +
    labs(title = "PL: Posterior distribution of W")
plot(p3)
})


if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-hva-posterior-W.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-mcmc-posterior-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
  
  ggsave(
        file.path(
            opath_real, "W",
            paste0("covid-", tag, "-pl-posterior-W.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300
    )
}
```


### Posterior of Rt

```{r}
p = plot_ts_ci_multi(
  list(
    LBA = log(exp(monterey.dat$out.lba2$fit$psi) + 1),
    MCS = log(exp(monterey.dat$out.mcs2$fit$psi) + 1),
    FFBS = log(exp(monterey.dat$out.ffbs2$fit$psi) + 1),
    PL = log(exp(monterey.dat$out.pl$fit$psi) + 1),
    # HVA = log(exp(monterey.dat$out.hva$fit$psi) + 1)
    # MCMC = log(exp(monterey.dat$out.mcmc$fit$psi) + 1),
    WT = monterey.dat$out.wt,
    EpiEstim = monterey.dat$out.epi
  ), 
  legend.position = "top"
)

p = p + ylab(expression(R[t]))
p = p + ylab(expression(R[t])) + 
  guides(color = guide_legend(nrow = 1)) +
  theme(text = element_text(size = 12))

plot(p)

if (mode == "save") {
  ggsave(
        file.path(
            opath_real, "posterior",
            paste0("covid-", tag, "-Rt.pdf")
        ),
        plot = p, device = "pdf", dpi = 300,
        width = 11.5, height = 4
    )
}
```


