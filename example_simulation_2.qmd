---
title: "Example - Simulation 2"
date: "`r Sys.Date()`"
author: "Meini Tang"
pdf-engine: pdflatex
format: 
  pdf:
    include-in-header:
      text: |
        \usepackage{geometry}
        \usepackage{booktabs}
        \usepackage{float}
        \usepackage{pdflscape}
        \usepackage{hhline}
    toc: true
    toc-depth: 2
    number-sections: true
    number-depth: 2
    fig-align: 'center'
    fig-pos: 'H'
    keep-tex: true
    tbl-cap-location: bottom
    layout-valign: bottom
error: true
---

```{r}
#| label: global argument
save_data <- FALSE
save_figures <- FALSE
plot_figures <- TRUE

seed <- 2793

kstep_forecast_err <- 10
eval_forecast_err <- FALSE
eval_fitted_err <- TRUE

loss <- "quadratic"
```

```{r}
#| label: source code

library(ggplot2)
library(gridExtra)

repo <- "/Users/meinitang/Dropbox/Repository/poisson-dlm"
Rcpp::sourceCpp(file.path(repo, "export.cpp"))
source(file.path(repo, "plot_timeseries_creditble_interval.r"))
source(file.path(repo, "external_methods.r"))

opath <- "/Users/meinitang/Dropbox/Research/Project1/simulation"
```


## Modal and Simulated Data

```{r}
#| label: model

component <- list(
    obs_dist = "nbinom",
    link_func = "identity",
    trans_func = "sliding",
    gain_func = "softplus",
    lag_dist = "lognorm",
    err_dist = "gaussian"
)
param <- list(
    obs = c(1, 30),
    lag = c(1.386262, 0.3226017), # mode = 2.8969
    err = c(0.01, 0)
)
dim <- list(
    nlag = 16,
    ntime = 200,
    truncated = TRUE,
    regressor_baseline = TRUE
)

mod1 <- list(
    model = component,
    param = param,
    dim = dim
)

rm(dim)
rm(param)
rm(component)
```


```{r}
#| label: simulated data(sim1)

set.seed(seed)
sim1 <- dgtf_simulate(mod1)

p1 <- ggplot(
    data = data.frame(y = sim1$y, t = 0:(length(sim1$y) - 1)),
    aes(x = t, y = y)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Observed Count Values y")

p2 <- ggplot(
    data = data.frame(psi = sim1$psi, t = 0:(length(sim1$psi) - 1)),
    aes(x = t, y = psi)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Latent State psi")


p <- arrangeGrob(grobs = list(y = p1, psi = p2), ncol = 1)

if (plot_figures) {
    plot(p)
}

```


```{r}
#| label: save figure of y

if (save_figures) {
    ggsave(
        file.path(opath, paste0("sim-", seed, "-y.pdf")),
        plot = p,
        device = "pdf", height = 5, width = 7, dpi = 300
    )
}
```

## Algorithm Comparison

### Linear Bayes

#### Parameter Tuning

```{r}
#| label: lba tuning discount factor

opts1.lba <- dgtf_default_algo_settings("lba")
opts1.lba$W <- 0.01
opts1.lba$use_discount <- TRUE
opts1.lba$use_custom <- TRUE
opts1.lba$num_step_ahead_forecast <- 10

opts1.lba$use_discount <- TRUE
opts1.lba$use_custom <- TRUE

delta.lba <- dgtf_tuning(
    mod1, sim1$y, "lba", opts1.lba,
    "discount_factor",
    from = 0.8, to = 1, delta = 0.01,
    loss = "absolute"
)

p1 <- ggplot(
    data.frame(delta = delta.lba[, 1], error = delta.lba[, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Discount Factor") +
    ylab("MFE") +
    theme(text = element_text(size = 16))

if (plot_figures) {
    plot(p1)
}
```


```{r}
#| label: lba tuning W

W_grid <- seq(from = 0.001, to = 0.04, by = 0.001)
opts1.lba$use_discount <- FALSE

W.lba <- dgtf_tuning(
    mod1, sim1$y, "lba", opts1.lba,
    "W",
    grid = W_grid,
    loss = "absolute"
)

p2 <- ggplot(
    data.frame(W = W.lba[, 1], error = W.lba[, 2]),
    aes(x = W, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("W") +
    ylab("MFE") +
    theme(text = element_text(size = 16))

if (plot_figures) {
    plot(p2)
}
```

```{r}
#| label: figure of lba tuning

if (save_figures) {
    ggsave(
        file.path(
            opath, "discount-factor",
            paste0("sim-", seed, "-lba-optimal-discount-factor.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(opath, "W", paste0("sim-", seed, "-lba-optimal-W.pdf")),
        plot = p2, device = "pdf", dpi = 300
    )
}

```

#### Optimal Settings

```{r}
#| label: optimal settings of lba


opts1.lba <- dgtf_default_algo_settings("lba")

opts1.lba$W <- 0.005

opts1.lba$use_discount <- TRUE
opts1.lba$use_custom <- TRUE

opts1.lba$discount_type = "first_elem"
opts1.lba$custom_discount_factor <- 0.88
```

#### Inference

```{r}
#| label: run dgtf_infer of lba with discount factor
opts1.lba$use_discount = TRUE
out1.lba <- dgtf_infer(
    mod1, sim1$y,
    "lba", opts1.lba,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err, 
    loss_func = loss
)

```

```{r}
#| label: run dgtf_infer of lba with W

opts1.lba$use_discount = FALSE

out1.lba2 <- dgtf_infer(
    mod1, sim1$y,
    "lba", opts1.lba,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err, 
    loss_func = loss
)

```

```{r}
#| label: evaluation of lba
#| error: true
print(print_loss_all(out1.lba))
print(print_loss_all(out1.lba2))
```

```{r}
#| label: figure of lba inference
tag <- paste0("sim-", seed, "-lba-")
plots <- plot_output(
    out1.lba, sim1$y, 
    psi_true = sim1$psi, W_true = sim1$param$err[1], mu0_true = sim1$param$obs[1], 
    save_figures = save_figures, tag = tag, opath = opath,
    plot_figures = plot_figures)

```

```{r}
#| label: save lba data

if (save_data) {
    save(
        out1.lba, out1.lba2, opts1.lba, delta.lba, W.lba, 
        out1.lba.loss_all, out1.lba2.loss_all,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, "-lba.RData")
        )
    )
}
```



### MCS

#### Parameter Tuning

```{r}
#| label: mcs tuning discount factor

opts1.mcs <- dgtf_default_algo_settings("mcs")
opts1.mcs$num_backward <- 4
opts1.mcs$num_particle <- 5000
opts1.mcs$num_step_ahead_forecast <- 10

opts1.mcs$W <- 0.01
opts1.mcs$use_discount <- TRUE
opts1.mcs$use_custom <- TRUE

delta.mcs <- dgtf_tuning(
    mod1, sim1$y, "mcs", opts1.mcs,
    "discount_factor",
    from = 0.65, to = 0.99, delta = 0.01
)

p1 <- ggplot(
    data.frame(delta = delta.mcs[delta.mcs[, 1] >= 0.7, 1], error = delta.mcs[delta.mcs[, 1] >= 0.7, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Discount Factor") +
    ylab("MFE") +
    theme(text = element_text(size = 16))

if (plot_figures) {
    plot(p1)
}
```


```{r}
#| label: mcs tuning W

W_grid <- seq(from = 0.001, to = 0.05, by = 0.001)
opts1.mcs$use_discount <- FALSE

W.mcs <- dgtf_tuning(
    mod1, sim1$y, "mcs", opts1.mcs,
    "W",
    grid = W_grid
)

p2 <- ggplot(
    data.frame(W = W.mcs[, 1], error = W.mcs[, 2], error2 = W.mcs[,3]),
    aes(x = W, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("W") +
    ylab("MFE") +
    theme(text = element_text(size = 16)) 
    # +
    # geom_point(aes(x=W, y = error2), color = "maroon") +
    # geom_line(aes(x=W, y = error2), alpha = 0.7, color = "salmon")

if (plot_figures) {
    plot(p2)
}
```


```{r}
#| label: mcs tuning B

opts1.mcs$use_discount <- TRUE
opts1.mcs$use_custom <- TRUE
opts1.mcs$custom_discount_factor <- 0.88

B.mcs <- dgtf_tuning(
    mod1, sim1$y, "mcs", opts1.mcs,
    "num_backward",
    from = 1, to = 30, delta = 1
)

p3 <- ggplot(
    data.frame(B = B.mcs[, 1], error = B.mcs[, 2]),
    aes(x = B, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("B") +
    ylab("Mean One-step-ahead Forecasting Error")

if (plot_figures) {
    plot(p3)
}
```

```{r}
#| label: figure of mcs tuning

if (save_figures) {
    ggsave(
        file.path(
            opath, "discount-factor",
            paste0("sim-", seed, "-mcs-optimal-discount-factor.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-mcs-optimal-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "num-backward",
            paste0("sim-", seed, "-mcs-optimal-B.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300
    )
}

```


#### Optimal Settings

```{r}
#| label: optimal settings of MCS

# mod1$model$obs_dist = "poisson"

opts1.mcs <- dgtf_default_algo_settings("mcs")
opts1.mcs$num_particle <- 5000
opts1.mcs$num_step_ahead_forecast <- 10

opts1.mcs$W <- 0.005

opts1.mcs$use_discount <- TRUE
opts1.mcs$use_custom <- TRUE
opts1.mcs$custom_discount_factor <- 0.88

opts1.mcs$num_backward <- 3
```

#### Inference

```{r}
#| label: run dgtf_infer of mcs with discount factor
opts1.mcs$use_discount <- TRUE
out1.mcs <- dgtf_infer(
    mod1, sim1$y,
    "mcs", opts1.mcs,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err,
    loss_func = loss
)
```


```{r}
#| label: run dgtf_infer of mcs with W
opts1.mcs$use_discount <- FALSE
out1.mcs2 <- dgtf_infer(
    mod1, sim1$y,
    "mcs", opts1.mcs,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err,
    loss_func = loss
)
```

```{r}
#| label: evaluation of mcs

print(print_loss_all(out1.mcs))
print(print_loss_all(out1.mcs2))
```


```{r}
#| label: figure of mcs inference

tag <- paste0("sim-", seed, "-mcs-")
plots <- plot_output(
    out1.mcs, sim1$y,
    psi_true = sim1$psi, W_true = sim1$param$err[1], mu0_true = sim1$param$obs[1],
    save_figures = save_figures, tag = tag, opath = opath,
    plot_figures = plot_figures
)
```


```{r}
#| label: save mcs data

if (save_data) {
    save(
        out1.mcs, out1.mcs2, opts1.mcs, delta.mcs, W.mcs, B.mcs,
        out1.mcs.loss_all, out1.mcs2.loss_all,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, "-mcs.RData")
        )
    )
}
```


### FFBS

#### Parameter Tuning

```{r}
#| label: ffbs tuning of discount factor

opts1.ffbs <- dgtf_default_algo_settings("ffbs")
opts1.ffbs$num_particle <- 5000
opts1.ffbs$num_smooth <- 1000
opts1.ffbs$do_smoothing <- TRUE
opts1.ffbs$num_step_ahead_forecast <- 10

opts1.ffbs$W <- 0.01
opts1.ffbs$use_discount <- TRUE
opts1.ffbs$use_custom <- TRUE
opts1.ffbs$custom_discount_factor <- 0.88

delta.ffbs <- dgtf_tuning(
    mod1, sim1$y, "ffbs", opts1.ffbs,
    "discount_factor",
    from = 0.8, to = 1, delta = 0.01
)

p1 <- ggplot(
    data.frame(delta = delta.ffbs[delta.ffbs[, 1] > 0.79, 1], error = delta.ffbs[delta.ffbs[, 1] > 0.79, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Discount Factor") +
    ylab("Mean One-step-ahead Forecasting Error") +
    theme(text = element_text(size = 16))

if (plot_figures) {
    plot(p1)
}

```

```{r}
#| label: ffbs tuning of W

W_grid <- seq(from = 0.001, to = 0.04, by = 0.001)
opts1.ffbs$use_discount <- FALSE

W.ffbs <- dgtf_tuning(
    mod1, sim1$y, "ffbs", opts1.ffbs,
    "W",
    grid = W_grid
)

p2 <- ggplot(
    data.frame(W = W.ffbs[W.ffbs[,1]<0.01, 1], error = W.ffbs[W.ffbs[,1]<0.01, 2]),
    aes(x = W, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("W") +
    ylab("Mean One-step-ahead Forecasting Error")

if (plot_figures) {
    plot(p2)
}

```

```{r}
#| label: figure of ffbs tuning

if (save_figures) {
    ggsave(
        file.path(
            opath, "discount-factor",
            paste0("sim-", seed, "-ffbs-optimal-discount-factor.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "W",
            paste0("sim-", seed, "-ffbs-optimal-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
}
```

#### Optimal Settings

```{r}
#| label: optimal settings of ffbs

opts1.ffbs <- dgtf_default_algo_settings("ffbs")
opts1.ffbs$num_particle <- 5000
opts1.ffbs$num_smooth <- 1000
opts1.ffbs$do_smoothing <- TRUE

opts1.ffbs$num_step_ahead_forecast <- 10

opts1.ffbs$W = 0.002

opts1.ffbs$use_discount <- TRUE
opts1.ffbs$use_custom <- TRUE
opts1.ffbs$custom_discount_factor <- 0.91

```

#### Inference

```{r}
#| label: run dgtf_infer with ffbs with discount factor
opts1.ffbs$use_discount <- TRUE
out1.ffbs <- dgtf_infer(
    mod1, sim1$y,
    "ffbs", opts1.ffbs,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err,
    loss_func = loss)

```

```{r}
#| label: run dgtf_infer with ffbs with W
opts1.ffbs$use_discount <- FALSE
out1.ffbs2 <- dgtf_infer(
    mod1, sim1$y,
    "ffbs", opts1.ffbs,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err,
    loss_func = loss)

```

```{r}
#| error: true
#| label: evaluation of ffbs

print(print_loss_all(out1.ffbs))
print(print_loss_all(out1.ffbs2))

```


```{r}
#| label: figure of ffbs inference

tag <- paste0("sim-", seed, "-ffbs-")
plots <- plot_output(
    out1.ffbs, sim1$y, 
    psi_true = sim1$psi, W_true = sim1$param$err[1], mu0_true = sim1$param$obs[1], 
    save_figures = save_figures, tag = tag, opath = opath,
    plot_figures = plot_figures)
```


```{r}
#| label: save ffbs data

if (save_data) {
    save(
        out1.ffbs, out1.ffbs2, opts1.ffbs, delta.ffbs, W.ffbs, 
        out1.ffbs.loss_all, out1.ffbs2.loss_all,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, "-ffbs.RData")
        )
    )
}
```


### Particle Learning

#### Inference

```{r}
#| label: run dgtf_infer with pl
opts1.pl = dgtf_default_algo_settings("pl")
opts1.pl$num_particle = 5000
opts1.pl$num_smooth = 500
opts1.pl$num_step_ahead_forecast = 10
opts1.pl$do_smoothing = TRUE

opts1.pl$W$init = 0.01
opts1.pl$W$infer = TRUE

out1.pl = dgtf_infer(
  mod1, sim1$y + 1, 
  "pl", opts1.pl,
  forecast_error = eval_forecast_err,
  fitted_error = eval_fitted_err,
  k = kstep_forecast_err)
```

```{r}
#| label: evaluation of pl

print(print_loss_all(out1.pl))
```

```{r}
#| label: figure of pl inference

tag <- paste0("sim-", seed, "-pl-")
plots <- plot_output(
    out1.pl, sim1$y,
    psi_true = sim1$psi, W_true = sim1$param$err[1], mu0_true = sim1$param$obs[1],
    save_figures = save_figures, tag = tag, opath = opath,
    plot_figures = plot_figures
)

```


```{r}
#| label: save pl data
if (save_data) {
    save(
        out1.pl, opts1.pl,
        out1.pl.loss_all,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, "-pl.RData")
        )
    )
}
```


### HVA

#### Parameter Tuning

```{r}
#| label: hva tuning of learning rate

opts1.hva <- dgtf_default_algo_settings("hva")
opts1.hva$nsample <- 1000
opts1.hva$nthin <- 2
opts1.hva$nburnin <- 1000
opts1.hva$mcs$num_particle <- 100
opts1.hva$mcs$num_backward <- 5
opts1.hva$num_step_ahead_forecast <- 10

opts1.hva$W$init <- 0.01
opts1.hva$W$infer <- TRUE

opts1.hva$eps_step_size <- 1.e-5
opts1.hva$k <- 1

lrate.hva <- dgtf_tuning(
    mod1, sim1$y, "hva", opts1.hva,
    "learning_rate",
    from = 0.01, to = 0.1, delta = 0.01
)

p1 <- ggplot(
    data.frame(delta = lrate.hva[, 1], error = lrate.hva[, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Learning Rate") +
    ylab("Mean One-step-ahead Forecasting Error")


if (plot_figures) {
    plot(p1)
}
```

```{r}
#| label: hva tuning of step size

opts1.hva$learning_rate <- 0.02

eps_grid <- c(1.e-6, 1.e-5, 1.e-3, 1.e-2)
eps.hva <- dgtf_tuning(
    mod1, sim1$y, "hva", opts1.hva,
    "step_size",
    grid = eps_grid
)

p2 <- ggplot(
    data.frame(delta = eps.hva[, 1], error = eps.hva[, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Step Size") +
    ylab("Mean One-step-ahead Forecasting Error")

if (plot_figures) {
    plot(p2)
}
```

```{r}
#| label: figure of hva tuning

if (save_figures) {
    ggsave(
        file.path(
            opath, "hva",
            paste0("sim-", seed, "-hva-optimal-learning-rate.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "hva",
            paste0("sim-", seed, "-hva-step-size.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
}

```

#### Optimal Settings

```{r}
#| label: optimal settings of hva

opts1.hva <- dgtf_default_algo_settings("hva")
opts1.hva$nsample <- 5000
opts1.hva$nthin <- 2
opts1.hva$nburnin <- 5000
opts1.hva$num_step_ahead_forecast <- 10

opts1.hva$mcs$num_particle <- 100
opts1.hva$mcs$num_backward <- 10

opts1.hva$W$init <- 0.01
opts1.hva$W$infer <- TRUE

opts1.hva$learning_rate <- 0.02
opts1.hva$eps_step_size <- 1.e-5
opts1.hva$k <- 1

```

#### Inference

```{r}
#| label: run dgtf_infer with hva

out1.hva <- dgtf_infer(
    mod1, sim1$y,
    "hva", opts1.hva,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err
)
```

```{r}
#| error: true
#| label: evaluation of hva

print(print_loss_all(out1.hva))
```


```{r}
#| label: figure of hva inference

tag <- paste0("sim-", seed, "-hva-")
plots <- plot_output(
    out1.hva, sim1$y, 
    psi_true = sim1$psi, W_true = sim1$param$err[1], mu0_true = sim1$param$obs[1], 
    save_figures = save_figures, tag = tag, opath = opath,
    plot_figures = plot_figures)


```

```{r}
#| label: save hva data
if (save_data) {
    tag <- paste0("sim-", seed, "-hva-")
    save(
        out1.hva, opts1.hva,
        out1.hva.loss_all,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, "-hva.RData")
        )
    )
}
```


### MCMC

#### Inference

```{r}
#| label: run dgtf_infer with mcmc
opts1.mcmc <- dgtf_default_algo_settings("mcmc")
opts1.mcmc$nsample <- 2000
opts1.mcmc$nthin <- 2
opts1.mcmc$nburnin <- 5000
opts1.mcmc$num_step_ahead_forecast <- 10

opts1.mcmc$mh_sd <- 0.1

opts1.mcmc$W$init <- 0.01
opts1.mcmc$W$infer <- TRUE

opts1.mcmc$mu0$init <- mod1$param$obs[1]
opts1.mcmc$mu0$infer = TRUE
opts1.mcmc$mu0$mh_sd = 1

out1.mcmc <- dgtf_infer(
    mod1, sim1$y,
    "mcmc", opts1.mcmc,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err
)
```

```{r}
#| label: evaluation of mcmc

print(print_loss_all(out1.mcmc))

```


```{r}
#| label: figure of mcmc

tag <- paste0("sim-", seed, "-mcmc-")
plots <- plot_output(
    out1.mcmc, sim1$y,
    psi_true = sim1$psi, W_true = sim1$param$err[1], mu0_true = sim1$param$obs[1],
    save_figures = save_figures, tag = tag, opath = opath,
    plot_figures = plot_figures
)

```


```{r}
#| label: save mcmc data

if (save_data) {
    save(
        out1.mcmc, opts1.mcmc,
        out1.mcmc.loss_all,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, "-mcmc.RData")
        )
    )
}
```



## Model Selection

### Optimal Observation Distribution

```{r}
#| label: optimal obs with lba
mod1$model$obs_dist = "nbinom"
delta_grid = 1:100
out1.stats.obs = dgtf_optimal_obs(mod1, sim1$y, "lba", opts1.lba, delta_grid)

mod1$model$obs_dist = "poisson"
out1.lba2 = dgtf_infer(mod1, sim1$y, "lba", opts1.lba)

ymin = min(c(out1.stats.obs[,2], out1.lba2$error$forecast$y_loss_all[1]))
ymax = max(c(out1.stats.obs[,2], out1.lba2$error$forecast$y_loss_all[1]))

out1.stats.obs = as.data.frame(out1.stats.obs)
colnames(out1.stats.obs) = c("delta", "forecast-err", "fit-err")
p = ggplot(out1.stats.obs, aes(x = delta, y = `forecast-err`)) +
  geom_point() + theme_light() +
  geom_hline(aes(yintercept = out1.lba2$error$forecast$y_loss_all[1]), color = "maroon") +
  ylab("RMSE of one-step-ahead forecasting") + xlab(expression(delta))


if (plot_figures) {
    plot(p)
}
```

```{r}
#| label: optimal obs with mcs
mod1$model$obs_dist <- "nbinom"
delta_grid <- 1:100
out1.stats.obs2 <- dgtf_optimal_obs(mod1, sim1$y, "mcs", opts1.mcs, delta_grid)

mod1$model$obs_dist <- "poisson"
out1.mcs2 <- dgtf_infer(mod1, sim1$y, "mcs", opts1.mcs)

ymin <- min(c(out1.stats.obs2[, 2], out1.mcs2$error$forecast$y_loss_all[1]))
ymax <- max(c(out1.stats.obs2[, 2], out1.mcs2$error$forecast$y_loss_all[1]))

out1.stats.obs2 <- as.data.frame(out1.stats.obs2)
colnames(out1.stats.obs2) <- c("delta", "forecast-err", "fit-err")
p <- ggplot(out1.stats.obs2, aes(x = delta, y = `forecast-err`)) +
    geom_point() +
    theme_light() +
    geom_hline(aes(yintercept = out1.mcs2$error$forecast$y_loss_all[1]), color = "maroon") +
    ylab("RMSE of one-step-ahead forecasting") +
    xlab(expression(delta))
    
if (plot_figures) {
    plot(p)
}
```

```{r}
#| label: optimal obs

mod1$model$obs_dist = "nbinom"
mod1$param$obs[2] = 50
```

### Optimal Lag Distribution

```{r}
#| label: lognormal lag dist with lba

mu_grid <- seq(from = 1, to = 3, by = 0.1)
sd2_grid <- seq(from = 0.1, to = 3, by = 0.1)
grids <- expand.grid(mu_grid, sd2_grid)
grids$mode <- exp(grids[, 1] - grids[, 2])
grids <- grids[grids$mode < 30, ]
mu_grid <- sort(unique(grids[, 1]))
sd2_grid <- sort(unique(grids[, 2]))

out1.stats.lag.lognorm <- dgtf_optimal_lag(
    mod1, sim1$y, "lba", opts1.lba,
    mu_grid, sd2_grid
)

out1.stats.lag.lognorm <- out1.stats.lag.lognorm[!apply(out1.stats.lag.lognorm, 1, anyNA), ]
out1.stats.lag.lognorm <- as.data.frame(out1.stats.lag.lognorm)
colnames(out1.stats.lag.lognorm) <- c("mu", "sd2", "mean", "var", "mode", "forecast", "fit")
out1.stats.lag.lognorm$mode_int <- as.factor(round(out1.stats.lag.lognorm$mode))

if (plot_figures) {
    lattice::contourplot(forecast ~ mu * sd2, data = out1.stats.lag.lognorm)
    ggplot(out1.stats.lag.lognorm, aes(mu, sd2, fill = forecast)) +
        geom_tile()
}


p <- ggplot(data = data.frame(
    mode = c(out1.stats.lag.lognorm$mode_int),
    mfe = c(out1.stats.lag.lognorm$forecast)
), aes(x = mode, y = mfe)) +
    theme_light() +
    geom_boxplot() +
    xlab("Mode") +
    ylab("RMSE of one-step-ahead forecasting")

if (plot_figures) {
    plot(p)
}


if (save_figures) {
    ggsave(
        file.path(
            opath, "model-selection",
            paste0("sim-", seed, "-lag-lognorm.pdf")
        ),
        plot = p, device = "pdf", dpi = 300
    )
}
```

```{r}
#| label: optimal param for lognormal lags
lognorm_param = c(2.6, 1.4)
```


```{r}
#| label: nbinom lag dist with lba
# mod1$model$obs_dist = "poisson"
mod1$model$lag_dist <- "nbinom"
mod1$param$lag <- c(0.395, 6)
kappa_grid <- seq(from = 0.1, to = 0.9, by = 0.05)
r_grid <- seq(from = 1, to = 6, by = 1)

out1.stats.lag.nbinom <- dgtf_optimal_lag(
    mod1, sim1$y, "lba", opts1.lba,
    kappa_grid, r_grid
)

out1.stats.lag.nbinom <- out1.stats.lag.nbinom[!apply(out1.stats.lag.nbinom, 1, anyNA), ]
out1.stats.lag.nbinom <- as.data.frame(out1.stats.lag.nbinom)
colnames(out1.stats.lag.nbinom) <- c("kappa", "r", "mean", "var", "mode", "forecast", "fit")
out1.stats.lag.nbinom$mode_int <- as.factor(round(out1.stats.lag.nbinom$mode))


if (plot_figures) {
    lattice::contourplot(forecast ~ kappa * r, data = out1.stats.lag.nbinom)

    ggplot(out1.stats.lag.nbinom, aes(kappa, r, fill = forecast)) +
        geom_tile()
}

p <- ggplot(data = data.frame(
    mode = c(out1.stats.lag.nbinom$mode_int),
    mfe = c(out1.stats.lag.nbinom$forecast)
), aes(x = mode, y = mfe)) +
    theme_light() +
    geom_boxplot() +
    xlab("Mode") +
    ylab("RMSE of one-step-ahead forecasting")

if (plot_figures) {
    plot(p)
}


if (save_figures) {
    ggsave(
        file.path(
            opath, "model-selection",
            paste0("sim-", seed, "-lag-nbinom.pdf")
        ),
        plot = p, device = "pdf", dpi = 300
    )
}
```


```{r}
#| label: save model selection

if (save_data) {
    save(
        mod1, sim1, 
        out1.stats.obs,
        out1.stats.obs2,
        out1.stats.lag.nbinom,
        out1.stats.lag.lognorm,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, ".RData")
        )
    )
}
```


## External Methods

```{r}
#| label: run external methods
si_para = lognorm2serial(1.386262, 0.3226017)
out1.epi = epi_poisson(c(sim1$y), si_para[1], si_para[2])
out1.wt = wt_poisson(c(sim1$y), si_para[1], si_para[2])
```

```{r}
#| label: figure of external methods
p1 <- plot_ts_ci_single(out1.epi)
p2 <- plot_ts_ci_single(out1.wt)

p3 <- plot_ts_ci_multi(list(
    LBA = log(exp(out1.lba$fit$psi) + 1),
    # HVB = log(exp(out1.hva$fit$psi) + 1),
    FFBS = log(exp(out1.ffbs$fit$psi) + 1),
    PL = log(exp(out1.pl$fit$psi) + 1),
    MCS = log(exp(out1.mcs$fit$psi) + 1),
    EpiEstim = out1.epi,
    WT = out1.wt,
    True = log(exp(cbind(sim1$psi, sim1$psi, sim1$psi) + 1))
), legend.position = "top")

if (plot_figures) {
    plot(p1)
    plot(p2)
    plot(p3)
}
```

```{r}
#| label: k step forecast for EpiEstim
forecast1.epi <- external_forecast(
    mod1, si_para, c(sim1$y), "EpiEstim",
    loss, kstep_forecast_err
)

if (save_data) {
    save(
        out1.epi, forecast1.epi,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, "-epi.RData")
        )
    )
}
```

```{r}
#| label: k step forecast for WT
forecast1.wt <- external_forecast(
    mod1, si_para, c(sim1$y), "WT",
    loss, kstep_forecast_err
)


if (save_data) {
    save(
        out1.wt, forecast1.wt,
        file = file.path(
            opath, "data",
            paste0("sim-", seed, "-wt.RData")
        )
    )
}
```


```{r}
#| label: figure of forcast comparison
dat <- data.frame(
    LBA = out1.lba$error$forecast$y_loss_all,
    MCS = out1.mcs$error$forecast$y_loss_all,
    FFBS = out1.ffbs$error$forecast$y_loss_all,
    PL = out1.pl$error$forecast$y_loss_all,
    EPI = forecast1.epi$y_loss_all,
    WT = forecast1.wt$y_loss_all,
    k = c(1:kstep_forecast_err)
)

dat2 <- reshape2::melt(dat, id.vars = "k", value.name = "MFE", variable.name = "algo")

p <- ggplot(dat2, aes(x = k, y = MFE, group = algo, color = algo)) +
    geom_line() +
    theme_light()

if (plot_figures) {
    plot(p)
}
```