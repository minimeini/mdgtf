---
title: "Example - Covid Monterey"
date: "`r Sys.Date()`"
author: "Meini Tang"
pdf-engine: pdflatex
format: 
  pdf:
    include-in-header:
      text: |
        \usepackage{geometry}
        \usepackage{booktabs}
        \usepackage{float}
        \usepackage{pdflscape}
        \usepackage{hhline}
    toc: true
    toc-depth: 2
    number-sections: true
    number-depth: 2
    fig-align: 'center'
    fig-pos: 'H'
    keep-tex: true
    tbl-cap-location: bottom
    layout-valign: bottom
error: true
---

```{r}
#| label: global argument
save_data <- FALSE
save_figures <- FALSE
plot_figures <- TRUE

tag <- "covid-monterey"
Tag2 = "Monterey"

kstep_forecast_err <- 10
eval_forecast_err <- TRUE
eval_fitted_err <- TRUE

loss <- "quadratic"
```

```{r}
#| label: source code
library(EpiEstim)
library(ggplot2)
library(gridExtra)

repo <- "/Users/meinitang/Dropbox/Repository/poisson-dlm"
Rcpp::sourceCpp(file.path(repo, "export.cpp"))
source(file.path(repo, "plot_timeseries_creditble_interval.r"))
source(file.path(repo, "external_methods.r"))

dpath <- "/Users/meinitang/Dropbox/Research/Project1"
opath <- "/Users/meinitang/Dropbox/Research/Project1/real"
```



## Modal and Data


```{r}
#| label: monterey county data
#|

data <- read.csv(file.path(dpath, "county", "covid19cases_test.csv"))
data <- data[data$area == Tag2, ]
data$date <- as.Date(data$date)
data <- data[data$date >= "2020-03-01", ]
data <- data[1:(nrow(data) - 1), ]

y <- data$cases
n <- length(y)

data2 <- data[data$date >= "2020-07-01" & data$date < "2021-12-01", ]
y2 <- c(0, data2$cases)

y3 <- round(smooth.spline(y2, spar = 0.0001)$y)
ggplot(
    data = data.frame(y = y2[-1], time = data2$date),
    aes(x = time, y = y)
) +
    geom_line() +
    theme_light()

p1 <- ggplot(
    data = data.frame(y = y2, t = 0:(length(y2) - 1)),
    aes(x = t, y = y)
) +
    geom_line() +
    theme_light() +
    xlab("Time t") +
    ylab("Observed Count Values y")


if (plot_figures) {
    plot(p1)
}
```

```{r}
#| label: save figure of y

if (save_figures) {
    ggsave(
        file.path(opath, paste0(tag, "-y.pdf")),
        plot = p1,
        device = "pdf", height = 5, width = 7, dpi = 300
    )
}
```


```{r}
#| label: model

component <- list(
    obs_dist = "nbinom",
    link_func = "identity",
    trans_func = "sliding",
    gain_func = "softplus",
    lag_dist = "nbinom",
    err_dist = "gaussian"
)
param <- list(
    obs = c(0, 5),
    lag = c(0.4, 6), # mode = 2.8969
    err = c(0.01, 0)
)
dim <- list(
    nlag = 16,
    ntime = length(y2) - 1,
    truncated = TRUE,
    regressor_baseline = TRUE
)

mod <- list(
    model = component,
    param = param,
    dim = dim
)

rm(dim)
rm(param)
rm(component)
```




## Algorithm Comparison

### Linear Bayes

#### Parameter Tuning

```{r}
#| label: lba tuning discount factor

opts.lba <- dgtf_default_algo_settings("lba")
opts.lba$W <- 0.01
opts.lba$use_discount <- TRUE
opts.lba$use_custom <- TRUE
opts.lba$num_step_ahead_forecast <- 10

opts.lba$use_discount <- TRUE
opts.lba$use_custom <- TRUE

delta.lba <- dgtf_tuning(
    mod, y2, "lba", opts.lba,
    "discount_factor",
    from = 0.7, to = 1, delta = 0.01,
    loss = "absolute"
)

p1 <- ggplot(
    data.frame(delta = delta.lba[, 1], error = delta.lba[, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Discount Factor") +
    ylab("MFE") +
    theme(text = element_text(size = 16))

if (plot_figures) {
    plot(p1)
}
```


```{r}
#| label: lba tuning W

W_grid <- seq(from = 0.001, to = 0.04, by = 0.001)
opts.lba$use_discount <- FALSE

W.lba <- dgtf_tuning(
    mod, y2, "lba", opts.lba,
    "W",
    grid = W_grid,
    loss = "absolute"
)

p2 <- ggplot(
    data.frame(W = W.lba[, 1], error = W.lba[, 2]),
    aes(x = W, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("W") +
    ylab("MFE") +
    theme(text = element_text(size = 16))

if (plot_figures) {
    plot(p2)
}
```

```{r}
#| label: figure of lba tuning

if (save_figures) {
    ggsave(
        file.path(
            opath, "discount-factor",
            paste0(tag, "-lba-optimal-discount-factor.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(opath, "W", paste0(tag, "-lba-optimal-W.pdf")),
        plot = p2, device = "pdf", dpi = 300
    )
}

```

#### Optimal Settings

```{r}
#| label: optimal settings of lba
opts.lba <- dgtf_default_algo_settings("lba")

opts.lba$W <- 0.008

opts.lba$use_discount <- TRUE
opts.lba$use_custom <- TRUE
# opts.lba$custom_discount_factor <- 0.85
opts.lba$custom_discount_factor <- 0.94
opts.lba$discount_type = "first_elem"
```

#### Inference

```{r}
#| label: run dgtf_infer of lba with discount factor
opts.lba$use_discount = TRUE
out.lba <- dgtf_infer(
    mod, y2,
    "lba", opts.lba,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err, 
    loss_func = loss
)

```

```{r}
#| label: run dgtf_infer of lba with W

opts.lba$use_discount = FALSE

out.lba2 <- dgtf_infer(
    mod, y2,
    "lba", opts.lba,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err, 
    loss_func = loss
)

```

```{r}
#| label: evaluation of lba
#| error: true
print(print_loss_all(out.lba))
print(print_loss_all(out.lba2))
```

    print(out.lba.loss_all)
    forecast1     forecast2     forecast3     forecast4     forecast5     forecast6     forecast7     forecast8     forecast9    forecast10 fitted-filter fitted-smooth 
     81.35155      88.58629      92.38286      91.81162      91.94772     101.29529     121.39831     150.57879     179.31700     204.02573      73.60857      69.42680 

```{r}
#| label: figure of lba inference
plots <- plot_output(
    out.lba, y2,
    save_figures = save_figures,
    tag = paste0(tag, "-lba-"), opath = opath,
    plot_figures = plot_figures
)

```

```{r}
#| label: save lba data

if (save_data) {
    save(
        out.lba, out.lba2, opts.lba, delta.lba, W.lba,
        out.lba.loss_all, out.lba2.loss_all,
        file = file.path(
            opath, "data",
            paste0(tag, "-lba.RData")
        )
    )
}
```



### MCS

#### Parameter Tuning

```{r}
#| label: mcs tuning discount factor

opts.mcs <- dgtf_default_algo_settings("mcs")
opts.mcs$num_backward <- 10
opts.mcs$num_particle <- 5000
opts.mcs$num_step_ahead_forecast <- 10

opts.mcs$W <- 0.01
opts.mcs$use_discount <- TRUE
opts.mcs$use_custom <- TRUE

delta.mcs <- dgtf_tuning(
    mod, y2, "mcs", opts.mcs,
    "discount_factor",
    from = 0.8, to = 1, delta = 0.005
)

p1 <- ggplot(
    data.frame(delta = delta.mcs[delta.mcs[, 1] >= 0.8, 1], error = delta.mcs[delta.mcs[, 1] >= 0.8, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Discount Factor") +
    ylab("MFE") +
    theme(text = element_text(size = 16))

if (plot_figures) {
    plot(p1)
}
```


```{r}
#| label: mcs tuning W

W_grid <- seq(from = 0.001, to = 0.05, by = 0.001)
opts.mcs$use_discount <- FALSE

W.mcs <- dgtf_tuning(
    mod, y2, "mcs", opts.mcs,
    "W",
    grid = W_grid
)

p2 <- ggplot(
    data.frame(W = W.mcs[, 1], error = W.mcs[, 2], error2 = W.mcs[,3]),
    aes(x = W, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("W") +
    ylab("MFE") +
    theme(text = element_text(size = 16)) 
    # +
    # geom_point(aes(x=W, y = error2), color = "maroon") +
    # geom_line(aes(x=W, y = error2), alpha = 0.7, color = "salmon")

if (plot_figures) {
    plot(p2)
}
```


```{r}
#| label: mcs tuning B

opts.mcs$use_discount <- TRUE
opts.mcs$use_custom <- TRUE
opts.mcs$custom_discount_factor <- 0.93

B.mcs <- dgtf_tuning(
    mod, y2, "mcs", opts.mcs,
    "num_backward",
    from = 1, to = 30, delta = 1
)

p3 <- ggplot(
    data.frame(B = B.mcs[, 1], error = B.mcs[, 2]),
    aes(x = B, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("B") +
    ylab("Mean One-step-ahead Forecasting Error")

if (plot_figures) {
    plot(p3)
}
```

```{r}
#| label: figure of mcs tuning

if (save_figures) {
    ggsave(
        file.path(
            opath, "discount-factor",
            paste0(tag, "-mcs-optimal-discount-factor.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "W",
            paste0(tag, "-mcs-optimal-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "num-backward",
            paste0(tag, "-mcs-optimal-B.pdf")
        ),
        plot = p3, device = "pdf", dpi = 300
    )
}
```


#### Optimal Settings

```{r}
#| label: optimal settings of MCS

# mod$model$obs_dist = "poisson"

opts.mcs <- dgtf_default_algo_settings("mcs")
opts.mcs$num_particle <- 10000
opts.mcs$num_step_ahead_forecast <- 10

opts.mcs$W <- 0.006

opts.mcs$use_discount <- TRUE
opts.mcs$use_custom <- TRUE
opts.mcs$custom_discount_factor <- 0.93

opts.mcs$num_backward <- 10

opts.mcs$mu0 = list(
    prior_name = "gamma",
    prior_param = c(2, 2)
)
```

#### Inference

```{r}
#| label: run dgtf_infer of mcs

opts.mcs$use_discount <- TRUE
out.mcs <- dgtf_infer(
    mod, y2,
    "mcs", opts.mcs,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err, 
    loss_func = loss
)
```

```{r}
#| label: run dgtf_infer of mcs

opts.mcs$use_discount <- FALSE
out.mcs2 <- dgtf_infer(
    mod, y2,
    "mcs", opts.mcs,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err, 
    loss_func = loss
)
```


```{r}
#| label: evaluation of mcs
print(print_loss_all(out.mcs))
print(print_loss_all(out.mcs2))
```


```{r}
#| label: figure of mcs inference

plots <- plot_output(
    out.mcs, y2,
    save_figures = save_figures,
    tag = paste0(tag, "-mcs-"), opath = opath,
    plot_figures = plot_figures
)
```


```{r}
#| label: save mcs data

if (save_data) {
    save(
        out.mcs, out.mcs2, opts.mcs, delta.mcs, W.mcs, B.mcs,
        out.mcs.loss_all, out.mcs2.loss_all,
        file = file.path(
            opath, "data",
            paste0(tag, "-mcs.RData")
        )
    )
}
```


### FFBS

#### Parameter Tuning

```{r}
#| label: ffbs tuning of discount factor
mod$model$obs_dist = "poisson"

opts.ffbs <- dgtf_default_algo_settings("ffbs")
opts.ffbs$num_particle <- 1000
opts.ffbs$num_smooth <- 500
opts.ffbs$do_smoothing <- TRUE
opts.ffbs$num_step_ahead_forecast <- 10

opts.ffbs$W <- 0.01
opts.ffbs$use_discount <- TRUE
opts.ffbs$use_custom <- TRUE
opts.ffbs$custom_discount_factor <- 0.88

delta.ffbs <- dgtf_tuning(
    mod, y2, "ffbs", opts.ffbs,
    "discount_factor",
    from = 0.95, to = 1, delta = 0.0005
)

p1 <- ggplot(
    data.frame(delta = delta.ffbs[, 1], error = delta.ffbs[, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Discount Factor") +
    ylab("Mean One-step-ahead Forecasting Error") +
    theme(text = element_text(size = 16))

if (plot_figures) {
    plot(p1)
}

```

```{r}
#| label: ffbs tuning of W

W_grid <- seq(from = 0.00001, to = 0.01, by = 0.0001)
opts.ffbs$use_discount <- FALSE

W.ffbs <- dgtf_tuning(
    mod, y2, "ffbs", opts.ffbs,
    "W",
    grid = W_grid
)

p2 <- ggplot(
    data.frame(W = W.ffbs[W.ffbs[, 1] < 0.01, 1], error = W.ffbs[W.ffbs[, 1] < 0.01, 2]),
    aes(x = W, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("W") +
    ylab("Mean One-step-ahead Forecasting Error")

if (plot_figures) {
    plot(p2)
}

```

```{r}
#| label: figure of ffbs tuning

if (save_figures) {
    ggsave(
        file.path(
            opath, "discount-factor",
            paste0(tag, "-ffbs-optimal-discount-factor.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "W",
            paste0(tag, "-ffbs-optimal-W.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
}
```

#### Optimal Settings

```{r}
#| label: optimal settings of ffbs

opts.ffbs <- dgtf_default_algo_settings("ffbs")
opts.ffbs$num_particle <- 5000
opts.ffbs$num_smooth <- 1000
opts.ffbs$do_smoothing <- TRUE

opts.ffbs$num_step_ahead_forecast <- 10

opts.ffbs$W = 0.0001

opts.ffbs$use_discount <- TRUE
opts.ffbs$use_custom <- TRUE
opts.ffbs$custom_discount_factor <- 0.996

```

#### Inference

```{r}
#| label: run dgtf_infer with ffbs
opts.ffbs$use_discount <- TRUE
out.ffbs <- dgtf_infer(
    mod, y2,
    "ffbs", opts.ffbs,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err,
    loss_func = loss)

```


```{r}
#| label: run dgtf_infer with ffbs
opts.ffbs$use_discount <- FALSE
out.ffbs2 <- dgtf_infer(
    mod, y2,
    "ffbs", opts.ffbs,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err,
    loss_func = loss)

```

```{r}
#| error: true
#| label: evaluation of ffbs

print(print_loss_all(out.ffbs))
print(print_loss_all(out.ffbs2))
```


```{r}
#| label: figure of ffbs inference

plots <- plot_output(
    out.ffbs, y2,
    save_figures = save_figures,
    tag = paste0(tag, "-ffbs-"), opath = opath,
    plot_figures = plot_figures
)
```


```{r}
#| label: save ffbs data

if (save_data) {
    save(
        out.ffbs, out.ffbs2, opts.ffbs, delta.ffbs, W.ffbs,
        out.ffbs.loss_all, out.ffbs2.loss_all,
        file = file.path(
            opath, "data",
            paste0(tag, "-ffbs.RData")
        )
    )
}
```


### Particle Learning

#### Inference

```{r}
#| label: run dgtf_infer with pl
opts.pl = dgtf_default_algo_settings("pl")
opts.pl$num_particle = 5000
opts.pl$num_smooth = 500
opts.pl$num_step_ahead_forecast = 10
opts.pl$do_smoothing = TRUE

opts.pl$W$init = 0.01
opts.pl$W$infer = TRUE

out.pl = dgtf_infer(
  mod, y2 + 1, 
  "pl", opts.pl,
  forecast_error = eval_forecast_err,
  fitted_error = eval_fitted_err,
  k = kstep_forecast_err)
```

```{r}
#| label: evaluation of pl
print(print_loss_all(out.pl))
```

```{r}
#| label: figure of pl inference


plots <- plot_output(
    out.pl, y2,
    save_figures = save_figures,
    tag = paste0(tag, "-pl-"), opath = opath,
    plot_figures = plot_figures
)

```


```{r}
#| label: save pl data
if (save_data) {
    save(
        out.pl, opts.pl,
        out.pl.loss_all,
        file = file.path(
            opath, "data",
            paste0(tag, "-pl.RData")
        )
    )
}
```


### HVA

#### Parameter Tuning

```{r}
#| label: hva tuning of learning rate

opts.hva <- dgtf_default_algo_settings("hva")
opts.hva$nsample <- 1000
opts.hva$nthin <- 2
opts.hva$nburnin <- 1000
opts.hva$mcs$num_particle <- 100
opts.hva$mcs$num_backward <- 5
opts.hva$num_step_ahead_forecast <- 10

opts.hva$W$init <- 0.01
opts.hva$W$infer <- TRUE

opts.hva$eps_step_size <- 1.e-5
opts.hva$k <- 1


lrate.hva <- dgtf_tuning(
    mod, y2, "hva", opts.hva,
    "learning_rate",
    from = 0.01, to = 0.1, delta = 0.01
)

p1 <- ggplot(
    data.frame(delta = lrate.hva[, 1], error = lrate.hva[, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Learning Rate") +
    ylab("Mean One-step-ahead Forecasting Error")

if (plot_figures) {
    plot(p1)
}
```

```{r}
#| label: hva tuning of step size

opts.hva$learning_rate <- 0.02

eps_grid <- c(1.e-6, 1.e-5, 1.e-3, 1.e-2)
eps.hva <- dgtf_tuning(
    mod, y2, "hva", opts.hva,
    "step_size",
    grid = eps_grid
)

p2 <- ggplot(
    data.frame(delta = eps.hva[, 1], error = eps.hva[, 2]),
    aes(x = delta, y = error)
) +
    geom_point() +
    theme_light() +
    geom_line(alpha = 0.7, color = "grey") +
    xlab("Step Size") +
    ylab("Mean One-step-ahead Forecasting Error")

if (plot_figures) {
    plot(p2)
}
```

```{r}
#| label: figure of hva tuning

if (save_figures) {
    ggsave(
        file.path(
            opath, "hva",
            paste0(tag, "-hva-optimal-learning-rate.pdf")
        ),
        plot = p1, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "hva",
            paste0(tag, "-hva-step-size.pdf")
        ),
        plot = p2, device = "pdf", dpi = 300
    )
}

```

#### Optimal Settings

```{r}
#| label: optimal settings of hva

opts.hva <- dgtf_default_algo_settings("hva")
opts.hva$nsample <- 5000
opts.hva$nthin <- 2
opts.hva$nburnin <- 5000
opts.hva$num_step_ahead_forecast <- 10

opts.hva$mcs$num_particle <- 100
opts.hva$mcs$num_backward <- 3

opts.hva$W$init <- 0.01
opts.hva$W$infer <- TRUE

opts.hva$learning_rate <- 0.02
opts.hva$eps_step_size <- 1.e-5
opts.hva$k <- 1

```

#### Inference

```{r}
#| label: run dgtf_infer with hva

out.hva <- dgtf_infer(
    mod, y2,
    "hva", opts.hva,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err
)
```

```{r}
#| error: true
#| label: evaluation of hva

print(print_loss_all(out.hva))
```


```{r}
#| label: figure of hva inference

plots <- plot_output(
    out.hva, y2,
    save_figures = save_figures, tag = paste0(tag, "-hva-"), opath = opath,
    plot_figures = plot_figures
)

```

```{r}
#| label: save hva data
if (save_data) {
    save(
        out.hva, opts.hva,
        out.hva.loss_all,
        file = file.path(
            opath, "data",
            paste0(tag, "-hva.RData")
        )
    )
}
```


### MCMC

#### Inference

```{r}
#| label: run dgtf_infer with mcmc
opts.mcmc <- dgtf_default_algo_settings("mcmc")
opts.mcmc$nsample <- 2000
opts.mcmc$nthin <- 2
opts.mcmc$nburnin <- 5000
opts.mcmc$num_step_ahead_forecast <- 10

opts.mcmc$mh_sd <- 0.1

opts.mcmc$mu0$init <- mod$param$obs[1]

opts.mcmc$W$init <- 0.01
opts.mcmc$W$infer <- TRUE



out.mcmc <- dgtf_infer(
    mod, y2,
    "mcmc", opts.mcmc,
    forecast_error = eval_forecast_err,
    fitted_error = eval_fitted_err,
    k = kstep_forecast_err
)
```

```{r}
#| label: evaluation of mcmc

print(print_loss_all(out.mcmc))

```


```{r}
#| label: figure of mcmc

plots <- plot_output(
    out.mcmc, y2,
    save_figures = save_figures,
    tag = paste0(tag, "-mcmc-"), opath = opath,
    plot_figures = plot_figures
)
```


```{r}
#| label: save mcmc data

if (save_data) {
    save(
        out.mcmc, opts.mcmc,
        out.mcmc.loss_all,
        file = file.path(
            opath, "data",
            paste0(tag, "-mcmc.RData")
        )
    )
}
```



## Model Selection

### Optimal Observation Distribution

```{r}
#| label: optimal obs with lba
mod$model$obs_dist <- "nbinom"
delta_grid <- 1:100
out.stats.obs <- dgtf_optimal_obs(mod, y2, "lba", opts.lba, delta_grid)

mod$model$obs_dist <- "poisson"
out.lba2 <- dgtf_infer(mod, y2, "lba", opts.lba)

ymin <- min(c(out.stats.obs[, 2], out.lba2$error$forecast$y_loss_all[1]))
ymax <- max(c(out.stats.obs[, 2], out.lba2$error$forecast$y_loss_all[1]))

out.stats.obs <- as.data.frame(out.stats.obs)
colnames(out.stats.obs) <- c("delta", "forecast-err", "fit-err")
p <- ggplot(out.stats.obs, aes(x = delta, y = `forecast-err`)) +
    geom_point() +
    theme_light() +
    geom_hline(aes(yintercept = out.lba2$error$forecast$y_loss_all[1]), color = "maroon") +
    ylab("RMSE of one-step-ahead forecasting") +
    xlab(expression(delta))

if (plot_figures) {
    plot(p)
}
```

```{r}
#| label: optimal obs with mcs
mod$model$obs_dist <- "nbinom"
delta_grid <- 1:100
out.stats.obs2 <- dgtf_optimal_obs(mod, y2, "mcs", opts.mcs, delta_grid)

mod$model$obs_dist <- "poisson"
out.mcs2 <- dgtf_infer(mod, y2, "mcs", opts.mcs)

ymin <- min(c(out.stats.obs2[, 2], out.mcs2$error$forecast$y_loss_all[1]))
ymax <- max(c(out.stats.obs2[, 2], out.mcs2$error$forecast$y_loss_all[1]))

out.stats.obs2 <- as.data.frame(out.stats.obs2)
colnames(out.stats.obs2) <- c("delta", "forecast-err", "fit-err")
p <- ggplot(out.stats.obs2, aes(x = delta, y = `forecast-err`)) +
    geom_point() +
    theme_light() +
    geom_hline(aes(yintercept = out.mcs2$error$forecast$y_loss_all[1]), color = "maroon") +
    ylab("RMSE of one-step-ahead forecasting") +
    xlab(expression(delta))

if (plot_figures) {
    plot(p)
}
```

```{r}
#| label: optimal obs

mod$model$obs_dist = "nbinom"
mod$param$obs[2] = 50
```

### Optimal Lag Distribution

```{r}
#| label: lognormal lag dist with lba
mod$model$lag_dist <- "lognorm"

mu_grid <- seq(from = 1, to = 3, by = 0.1)
sd2_grid <- seq(from = 0.1, to = 3, by = 0.1)
grids <- expand.grid(mu_grid, sd2_grid)
grids$mode <- exp(grids[, 1] - grids[, 2])
grids <- grids[grids$mode < 30, ]
mu_grid <- sort(unique(grids[, 1]))
sd2_grid <- sort(unique(grids[, 2]))

out.stats.lag.lognorm <- dgtf_optimal_lag(
    mod, y2, "lba", opts.lba,
    mu_grid, sd2_grid
)

out.stats.lag.lognorm <- out.stats.lag.lognorm[!apply(out.stats.lag.lognorm, 1, anyNA), ]
out.stats.lag.lognorm <- as.data.frame(out.stats.lag.lognorm)
colnames(out.stats.lag.lognorm) <- c("mu", "sd2", "mean", "var", "mode", "forecast", "fit")
out.stats.lag.lognorm$mode_int <- as.factor(round(out.stats.lag.lognorm$mode))

p0 <- ggplot(out.stats.lag.lognorm, aes(mu, sd2, fill = forecast)) +
    geom_raster(na.rm = TRUE) +
    theme_minimal() +
    theme(
        legend.position = "top",
        text = element_text(size = 20),
        legend.key.size = unit(0.5, "inches"),
        panel.spacing = unit(0, "inches")
    ) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0))

p <- ggplot(data = data.frame(
    mode = c(out.stats.lag.lognorm$mode_int),
    mfe = c(out.stats.lag.lognorm$forecast)
), aes(x = mode, y = mfe)) +
    theme_light() +
    geom_boxplot() +
    xlab("Mode") +
    ylab("RMSE of one-step-ahead forecasting")

if (plot_figures) {
    lattice::contourplot(forecast ~ mu * sd2, data = out.stats.lag.lognorm)

    plot(p0)
    plot(p)
}

if (save_figures) {
    ggsave(
        file.path(
            opath, "model-selection",
            paste0(tag, "-lag-lognorm.pdf")
        ),
        plot = p, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "model-selection",
            paste0(tag, "-lag-lognorm-heatmap.pdf")
        ),
        plot = p0, device = "pdf", dpi = 300
    )
}
```

```{r}
#| label: optimal param for lognormal lags
lognorm_param = c(1.4, 0.1)
```


```{r}
#| label: nbinom lag dist with lba
mod$model$lag_dist <- "nbinom"
mod$param$lag <- c(0.395, 6)
kappa_grid <- seq(from = 0.1, to = 0.9, by = 0.05)
r_grid <- seq(from = 1, to = 6, by = 1)

out.stats.lag.nbinom <- dgtf_optimal_lag(
    mod, y2, "lba", opts.lba,
    kappa_grid, r_grid
)

out.stats.lag.nbinom <- out.stats.lag.nbinom[!apply(out.stats.lag.nbinom, 1, anyNA), ]
out.stats.lag.nbinom <- as.data.frame(out.stats.lag.nbinom)
colnames(out.stats.lag.nbinom) <- c("kappa", "r", "mean", "var", "mode", "forecast", "fit")
out.stats.lag.nbinom$mode_int <- as.factor(round(out.stats.lag.nbinom$mode))


p0 <- ggplot(out.stats.lag.nbinom, aes(kappa, r, fill = forecast)) +
    geom_raster(na.rm = TRUE) +
    theme_minimal() +
    theme(
        legend.position = "top",
        text = element_text(size = 20),
        legend.key.size = unit(0.5, "inches"),
        panel.spacing = unit(0, "inches")
    ) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0))


p <- ggplot(data = data.frame(
    mode = c(out.stats.lag.nbinom$mode_int),
    mfe = c(out.stats.lag.nbinom$forecast)
), aes(x = mode, y = mfe)) +
    theme_light() +
    geom_boxplot() +
    xlab("Mode") +
    ylab("RMSE of one-step-ahead forecasting")

if (plot_figures) {
    lattice::contourplot(forecast ~ kappa * r, data = out.stats.lag.nbinom)

    plot(p0)
    plot(p)
}


if (save_figures) {
    ggsave(
        file.path(
            opath, "model-selection",
            paste0(tag, "-lag-nbinom.pdf")
        ),
        plot = p, device = "pdf", dpi = 300
    )

    ggsave(
        file.path(
            opath, "model-selection",
            paste0(tag, "-lag-nbinom-heatmap.pdf")
        ),
        plot = p0, device = "pdf", dpi = 300
    )
}
```

```{r}
#| label: optimal param for nbinom lag
nbinom_param = c(0.45, 6)
```

```{r}
#| label: save model selection

if (save_data) {
    save(
        mod, y2,
        out.stats.obs,
        out.stats.obs2,
        out.stats.lag.nbinom,
        out.stats.lag.lognorm,
        lognorm_param,
        nbinom_param,
        file = file.path(
            opath, "data",
            paste0(tag, ".RData")
        )
    )
}
```


## External Methods

```{r}
#| label: run external methods
si_para = lognorm2serial(1.386262, 0.3226017)
out.epi = epi_poisson(c(y2), si_para[1], si_para[2])
out.wt = wt_poisson(c(y2), si_para[1], si_para[2])
```

```{r}
#| label: figure of external methods
p1 <- plot_ts_ci_single(out.epi)
p2 <- plot_ts_ci_single(out.wt)

p3 <- plot_ts_ci_multi(list(
    LBA = log(exp(out.lba$fit$psi) + 1),
    # HVB = log(exp(out1.hva$fit$psi) + 1),
    FFBS = log(exp(out.ffbs$fit$psi) + 1),
    PL = log(exp(out.pl$fit$psi) + 1),
    MCS = log(exp(out.mcs$fit$psi) + 1),
    EpiEstim = out.epi,
    WT = out.wt
), legend.position = "top")

if (plot_figures) {
    plot(p1)
    plot(p2)
    plot(p3)
}
```

```{r}
#| label: k step forecast for EpiEstim
forecast.epi <- external_forecast(
    mod, si_para, c(y2), "EpiEstim",
    loss, kstep_forecast_err
)

if (save_data) {
    save(
        out.epi, forecast.epi,
        file = file.path(
            opath, "data",
            paste0(tag, "-epi.RData")
        )
    )
}
```

```{r}
#| label: k step forecast for WT
forecast.wt <- external_forecast(
    mod, si_para, c(y2), "WT",
    loss, kstep_forecast_err
)


if (save_data) {
    save(
        out.wt, forecast.wt,
        file = file.path(
            opath, "data",
            paste0(tag, "-wt.RData")
        )
    )
}
```


```{r}
#| label: figure of forcast comparison
dat <- data.frame(
    LBA = out.lba$error$forecast$y_loss_all,
    MCS = out.mcs$error$forecast$y_loss_all,
    FFBS = out.ffbs$error$forecast$y_loss_all,
    PL = out.pl$error$forecast$y_loss_all,
    EPI = forecast.epi$y_loss_all,
    WT = forecast.wt$y_loss_all,
    k = c(1:kstep_forecast_err)
)

dat2 <- reshape2::melt(dat, id.vars = "k", value.name = "MFE", variable.name = "algo")

p <- ggplot(dat2, aes(x = k, y = MFE, group = algo, color = algo)) +
    geom_line() +
    theme_light()

if (plot_figures) {
    plot(p)
}
```